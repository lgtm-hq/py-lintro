---
services:
  # Main lintro service for running linting on your code
  # Usage: docker compose run --rm lintro check --tools ruff,prettier /code
  lintro:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TOOLS_IMAGE: ${TOOLS_IMAGE:-ghcr.io/lgtm-hq/lintro-tools:latest@sha256:19c1cd7e4ba40f5101282de5049058ca6bc9b929ecc6dc73fa1ae05f63f584ff}
        WITH_AI: ${WITH_AI:-false}
    logging:
      driver: local
      options:
        max-size: '10m'
        max-file: '3'
    volumes:
      # Mount current directory to /code (not /app to avoid overwriting the app)
      - ${PWD:-./}:/code
    working_dir: /code
    environment:
      # Pass AI provider API keys through to the container (optional)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

  # Integration test runner - mounts source for development testing
  # Usage: docker compose run --rm test-integration
  # Note: This service mounts to /app for testing the current source code
  test-integration:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TOOLS_IMAGE: ${TOOLS_IMAGE:-ghcr.io/lgtm-hq/lintro-tools:latest@sha256:19c1cd7e4ba40f5101282de5049058ca6bc9b929ecc6dc73fa1ae05f63f584ff}
    image: py-lintro-test:latest
    logging:
      driver: local
      options:
        max-size: '10m'
        max-file: '3'
    working_dir: /app
    volumes:
      # Mount source to /app for testing against current code
      # This intentionally overwrites the built app for development
      - ${PWD:-./}:/app
    command:
      - /app/scripts/local/run-tests.sh
    entrypoint:
      - ''
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - RUNNING_IN_DOCKER=1
      - DOCKER_BUILDKIT=0
      - COVERAGE_OUTPUT_DIR=/app
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    user: root
    shm_size: 256m
    # Run as root to avoid permission issues with mounted volumes
